<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Week 2: Button Input & If/Else Logic ‚Äî interactive lesson for an electronics class. Optimized for GitHub Pages hosting." />
  <meta name="theme-color" content="#f97316" />
  <title>Week 2: Button Input & If/Else Logic</title>

  <script>
  tailwind.config = { darkMode: 'class' }
</script>

  <!-- Tailwind via CDN (OK for GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">

  <!-- Lucide icons (load once) -->
  <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script>

  <style>
    :root{--primary:#f97316;--muted:#94a3b8}
    html{scroll-behavior:smooth}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.45}

    /* Code area visuals - keep simple so Tailwind can handle rest */
    .code-block{font-family:'Fira Code',monospace;font-size:0.9rem;line-height:1.3}

    /* Simple LED indicator */
    .led {width:28px;height:28px;border-radius:9999px;background:#1f2937;box-shadow:inset 0 -2px 4px rgba(0,0,0,.6);transition:box-shadow .15s, background .15s}
    .led.on{background:var(--primary);box-shadow:0 0 10px rgba(249,115,22,.6)}

    /* Toast */
    .toast {position:fixed;right:1rem;top:1rem;z-index:60;display:flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border-radius:.5rem;background:var(--primary);color:white;transform:translateX(120%);transition:transform .35s}
    .toast.show{transform:translateX(0)}

    /* Accessible focus outline override */
    :focus{outline:3px solid rgba(249,115,22,.22);outline-offset:2px}

    /* Mobile toc panel */
    .toc-panel{backdrop-filter:blur(6px)}
  .dyslexia-mode body{font-family:'Lexend',Inter,sans-serif;letter-spacing:0.06em;line-height:1.5;}
.dyslexia-mode *{animation:none!important;text-shadow:none!important;}
</style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">

  <a class="sr-only focus:not-sr-only p-2" href="#main">Skip to content</a>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <button id="dyslexiaToggle" aria-pressed="false" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Toggle dyslexia mode">üÖì</button>
        <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><circle cx="12" cy="12" r="10" fill="var(--primary)"/></svg>
        <div>
          <h1 class="text-lg font-extrabold">Week 2: Button Input & If/Else Logic</h1>
          <p class="text-xs text-muted-foreground text-slate-500 dark:text-slate-300">Interactive lesson ‚Äî 90 minutes</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="tocBtn" aria-controls="tocPanel" aria-expanded="false" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700" title="Open table of contents">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="sr-only">Open table of contents</span>
        </button>

        <button id="themeToggle" aria-pressed="false" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Toggle dark mode">
          <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="currentColor"/></svg>
          <span class="sr-only">Toggle theme</span>
        </button>
      </div>
    </div>

    <!-- progress + nav -->
    <div class="max-w-6xl mx-auto px-4 pb-3">
      <div class="flex items-center justify-between gap-4">
        <div class="flex-1 pr-4">
          <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
            <div id="progressBar" class="h-full bg-orange-500 w-0" style="transition:width .6s"></div>
          </div>
          <div id="progressTime" class="text-xs text-slate-500 dark:text-slate-400 mt-1">0:00 / 90 min</div>
        </div>

        <nav aria-label="Lesson sections" class="hidden sm:flex gap-2">
          <a href="#part1" class="nav-link text-sm px-2 py-1 rounded hover:text-orange-600">Part 1</a>
          <a href="#part2" class="nav-link text-sm px-2 py-1 rounded hover:text-orange-600">Part 2</a>
          <a href="#part3" class="nav-link text-sm px-2 py-1 rounded hover:text-orange-600">Part 3</a>
          <a href="#part4" class="nav-link text-sm px-2 py-1 rounded hover:text-orange-600">Part 4</a>
          <a href="#part5" class="nav-link text-sm px-2 py-1 rounded hover:text-orange-600">Part 5</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Mobile TOC panel -->
  <aside id="tocPanel" class="fixed inset-y-0 right-0 w-80 max-w-full bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-700 p-4 transform translate-x-full transition-transform toc-panel" aria-hidden="true">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">Contents</h2>
      <button id="tocClose" class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700"><span class="sr-only">Close</span>&times;</button>
    </div>
    <nav class="mt-4 space-y-2" aria-label="Mobile lesson navigation">
      <a href="#part1" class="block p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">PART 1: Hook</a>
      <a href="#part2" class="block p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">PART 2: Button Theory</a>
      <a href="#part3" class="block p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">PART 3: Guided Build</a>
      <a href="#part4" class="block p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">PART 4: Toggle</a>
      <a href="#part5" class="block p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">PART 5: Wrap-up</a>
      <a href="#vocabulary" class="block p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">Vocabulary</a>
    </nav>
  </aside>

  <main id="main" class="max-w-6xl mx-auto px-4 py-8">

    <!-- Vocabulary -->
    <section id="vocabulary" class="mb-10 scroll-mt-20">
      <h2 class="text-2xl font-bold text-orange-600">Enhanced Vocabulary</h2>
      <div class="grid sm:grid-cols-2 gap-4 mt-4">
        <article class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
          <h3 class="font-semibold">digitalRead()</h3>
          <p class="text-sm text-slate-600 dark:text-slate-300">Reads the value of a digital pin (<strong>HIGH</strong> or <strong>LOW</strong>).</p>
        </article>
        <article class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
          <h3 class="font-semibold">INPUT / OUTPUT</h3>
          <p class="text-sm text-slate-600 dark:text-slate-300">Pin configuration: <strong>OUTPUT</strong> sends signals, <strong>INPUT</strong> receives.</p>
        </article>
        <article class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
          <h3 class="font-semibold">if/else statement</h3>
          <p class="text-sm text-slate-600 dark:text-slate-300">Decision structure: <strong>IF</strong> condition then do X, <strong>ELSE</strong> do Y.</p>
        </article>
        <article class="p-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700">
          <h3 class="font-semibold">INPUT_PULLUP</h3>
          <p class="text-sm text-slate-600 dark:text-slate-300">Internally pulls the pin HIGH, so pressed = LOW. Prevents floating values.</p>
        </article>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1" class="mb-10 scroll-mt-20">
      <div class="flex items-center gap-3 mb-4">
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2v6l4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h2 class="text-xl font-bold">PART 1: Review & Hook (0:00-0:12)</h2>
      </div>

      <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
        <h3 class="font-semibold text-lg">Warm-Up: Fix the Broken Code</h3>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">Edit the code and submit your fix. Hint: the LED never turns off because the same value is written twice.</p>

        <label for="brokenCode" class="sr-only">Broken code editor</label>
        <textarea id="brokenCode" rows="8" class="w-full mt-3 p-3 rounded code-block bg-slate-900 text-amber-100" aria-label="Broken code editor">void setup() {
  pinMode(13, OUTPUT);
}

void loop() {
  digitalWrite(13, HIGH);
  delay(100);
  digitalWrite(13, HIGH);  // ‚Üê ERROR IS HERE
  delay(100);
}
</textarea>
<div class="mt-2"><a href="https://wokwi.com/projects/new?template=arduino" target="_blank" class="inline-block mt-2 px-3 py-1 rounded bg-green-200 dark:bg-green-700 text-sm">Simulate on Wokwi</a></div>

        <div class="flex gap-2 mt-3">
          <button id="checkFix" class="bg-green-600 text-white px-3 py-2 rounded">Submit Fix</button>
          <button id="copyBroken" class="px-3 py-2 rounded border">Copy</button>
        </div>

        <div id="fixFeedback" class="mt-3 p-3 rounded hidden" role="status" aria-live="polite"></div>

        <p class="mt-4 text-sm text-slate-600 dark:text-slate-300"><strong>Connection:</strong> Today we move from output (LED blink) to input (user control). By the end you'll build a toggle switch.</p>
      </div>
    </section>

    <!-- PART 2 -->
    <section id="part2" class="mb-10 scroll-mt-20">
      <div class="flex items-center gap-3 mb-4">
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h2 class="text-xl font-bold">PART 2: Button Theory & Wiring (0:12-0:30)</h2>
      </div>

      <div class="grid sm:grid-cols-2 gap-4">
        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
          <h3 class="font-semibold">Button as a Switch</h3>
          <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">A button closes the circuit when pressed. If you use INPUT_PULLUP, NOT pressed = HIGH, pressed = LOW.</p>

          <div class="mt-4 flex items-center gap-4">
            <div class="text-center">
              <div class="w-24 h-16 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded">
                <div class="text-xs">Unpressed</div>
              </div>
            </div>
            <div class="text-center">
              <div class="w-24 h-16 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded">
                <div class="text-xs">Pressed</div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
          <h3 class="font-semibold">INPUT_PULLUP (Simplified)</h3>
          <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">The pin is internally pulled HIGH. Pressing the button connects the pin to GND making it LOW.</p>

          <div class="mt-3 space-y-2">
            <a href="https://www.arduino.cc/en/Tutorial/BuiltInExamples/Button" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-2 rounded bg-orange-100 text-orange-700 hover:bg-orange-200">Arduino button tutorial</a>
            <a href="https://wokwi.com/" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-2 rounded border">Open Wokwi</a>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3" class="mb-10 scroll-mt-20">
      <div class="flex items-center gap-3 mb-4">
        <svg width="28" height="28" viewBox="0 0 24 24"><path d="M12 2l4 7h-8l4-7zM2 22h20" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h2 class="text-xl font-bold">PART 3: Guided Build & Basic Response (0:30-0:55)</h2>
      </div>

      <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
        <h3 class="font-semibold mb-2">Step-by-step: Button Input</h3>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <ol class="list-decimal pl-5 text-sm text-slate-600 dark:text-slate-300 space-y-2">
              <li>Keep the LED on Pin 13 (with resistor).</li>
              <li>Place the button straddling the middle gap of the breadboard.</li>
              <li>Connect one button leg to Arduino Pin 2.</li>
              <li>Connect the opposite leg to GND.</li>
            </ol>
          </div>

          <div>
            <div class="relative">
              <button id="copyBasicCode" class="absolute right-2 top-2 text-xs px-2 py-1 rounded border">Copy</button>
              <pre class="code-block p-3 rounded bg-slate-900 text-amber-100 overflow-auto" aria-hidden="false" tabindex="0">// Basic digital input
const int buttonPin = 2;
const int ledPin = 13;
int buttonState = 0;

void setup() {
  pinMode(ledPin, OUTPUT);
  pinMode(buttonPin, INPUT_PULLUP);
}

void loop() {
  buttonState = digitalRead(buttonPin);
  if (buttonState == LOW) {
    digitalWrite(ledPin, HIGH);
  } else {
    digitalWrite(ledPin, LOW);
  }
}
</pre>
<div class="mt-2"><a href="https://wokwi.com/projects/new?template=arduino" target="_blank" class="inline-block mt-2 px-3 py-1 rounded bg-green-200 dark:bg-green-700 text-sm">Simulate on Wokwi</a></div>
            </div>
          </div>
        </div>

        <details class="mt-4 p-3 rounded bg-red-50 dark:bg-red-900/30">
          <summary class="font-semibold">Troubleshooting flow</summary>
          <ul class="mt-2 text-sm text-slate-600 dark:text-slate-300 pl-4 list-disc">
            <li>LED always on/off? Check diagonal legs and pin connections.</li>
            <li>Flicker? Loose wires.</li>
            <li>Upload fails? Check Tools ‚Üí Port.</li>
          </ul>
        </details>
      </div>

      <!-- Challenges -->
      <div class="mt-4 grid sm:grid-cols-2 gap-4">
        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
          <h4 class="font-semibold">Challenge 1: Reverse Logic</h4>
          <p class="text-sm text-slate-600 dark:text-slate-300">Make LED ON when NOT pressed.</p>
          <pre class="code-block p-2 bg-slate-100 dark:bg-slate-700 rounded text-xs mt-2">if (buttonState == HIGH) { ... }</pre>
        </div>

        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
          <h4 class="font-semibold">Challenge 2: Strobe Effect</h4>
          <p class="text-sm text-slate-600 dark:text-slate-300">Blink rapidly while pressed.</p>
          <pre class="code-block p-2 bg-slate-100 dark:bg-slate-700 rounded text-xs mt-2">if (buttonState == LOW) {
  digitalWrite(ledPin, HIGH);
  delay(100);
  digitalWrite(ledPin, LOW);
  delay(100);
}</pre>
        </div>
      </div>
    </section>

    <!-- PART 4 -->
    <section id="part4" class="mb-10 scroll-mt-20">
      <div class="flex items-center gap-3 mb-4">
        <svg width="28" height="28" viewBox="0 0 24 24"><path d="M12 3v18" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h2 class="text-xl font-bold">PART 4: Independent Practice - Toggle Switch (0:55-1:20)</h2>
      </div>

      <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
        <h3 class="font-semibold">Ultimate Challenge: Toggle LED</h3>
        <p class="text-sm text-slate-600 dark:text-slate-300">Detect the transition (HIGH‚ÜíLOW) and flip the stored state.</p>

        <label for="toggleTemplate" class="sr-only">Toggle code template</label>
        <textarea id="toggleTemplate" rows="14" class="w-full mt-3 p-3 rounded code-block bg-slate-900 text-amber-100" aria-label="Toggle code template">const int buttonPin = 2;
const int ledPin = 13;

bool ledIsOn = false;           // Track LED state
int lastButtonState = HIGH;     // Track button state for change detection

void setup() {
  pinMode(ledPin, OUTPUT);
  pinMode(buttonPin, INPUT_PULLUP);
}

void loop() {
  int buttonState = digitalRead(buttonPin);
  if (buttonState == LOW && lastButtonState == HIGH) {
    ledIsOn = !ledIsOn;
    if (ledIsOn) digitalWrite(ledPin, HIGH);
    else digitalWrite(ledPin, LOW);
    delay(200); // debounce
  }
  lastButtonState = buttonState;
  delay(10);
}
</textarea>

        <div class="flex gap-2 mt-3">
          <button id="simulateToggle" class="bg-orange-600 text-white px-3 py-2 rounded">Simulate Toggle Logic</button>
          <button id="copyToggle" class="px-3 py-2 rounded border">Copy</button>
        </div>

        <div class="mt-4 flex items-center gap-4">
          <div class="flex items-center gap-2">
            <div id="visualLed" class="led" aria-hidden="true"></div>
            <div class="text-xs">LED</div>
          </div>

          <div class="flex items-center gap-2">
            <button id="visualBtn" class="px-3 py-1 rounded bg-slate-100 dark:bg-slate-700">Simulated Button</button>
            <div class="text-xs">(Click to press)</div>
          </div>
        </div>
      </div>

      <!-- Extension -->
      <div class="mt-4 bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-xl border border-yellow-200 dark:border-yellow-800">
        <h4 class="font-semibold">Extension: Two-Button Control</h4>
        <p class="text-sm text-slate-600 dark:text-slate-300">Button 1 turns LED ON, Button 2 turns it OFF.</p>
      </div>
    </section>

    <!-- PART 5 -->
    <section id="part5" class="mb-10 scroll-mt-20">
      <div class="flex items-center gap-3 mb-4">
        <svg width="28" height="28" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h2 class="text-xl font-bold">PART 5: Synthesis & Wrap-Up (1:20-1:30)</h2>
      </div>

      <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
        <h3 class="font-semibold">Show & Tell</h3>
        <label for="showTellReflection" class="sr-only">Reflection</label>
        <textarea id="showTellReflection" rows="3" class="mt-2 w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" placeholder="What was the hardest part and how did you solve it?"></textarea>
      </div>

      <div class="mt-4 bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
        <h3 class="font-semibold">Exit Ticket</h3>
        <ol class="list-decimal pl-5 mt-2 text-sm text-slate-600 dark:text-slate-300 space-y-2">
          <li>What does <code>int buttonState = digitalRead(2);</code> do?</li>
          <li>List three checks if the button circuit doesn't work.</li>
          <li>How is a button like a light switch?</li>
        </ol>

        <div class="mt-3">
          <label class="sr-only">Confidence</label>
          <select id="confidence" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600">
            <option>Select your confidence level</option>
            <option>I can build a button circuit and basic code (Ready for next week)</option>
            <option>I need more practice with buttons and if/else logic</option>
            <option>I'm ready for sensors next week</option>
          </select>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="saveReflection" class="bg-orange-600 text-white px-3 py-2 rounded">Save Answers</button>
          <button id="downloadNotes" class="px-3 py-2 rounded border">Download Notes</button>
        </div>
      </div>

    </section>

  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" hidden>
    <svg width="16" height="16" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span id="toastMsg">Saved</span>
  </div>

  <footer class="max-w-6xl mx-auto px-4 py-6 text-xs text-slate-500">
    <div class="flex items-center justify-between">
      <div>Made for classroom use ‚Ä¢ Host on GitHub Pages</div>
      <div>Last updated: <span id="lastUpdated">‚Äî</span></div>
    </div>
  </footer>

  <script>
    // ---------- App State ----------
    const APP_KEY;
    let dyslexia = localStorage.getItem('pref_dyslexia')==='on';
     = 'week2_electronics_state_v1';
    const sectionTimes = {
      'part1': {start:0,end:12,name:'Review & Hook'},
      'part2': {start:12,end:30,name:'Button Theory & Wiring'},
      'part3': {start:30,end:55,name:'Guided Build & Basic Response'},
      'part4': {start:55,end:80,name:'Independent Practice - Toggle Switch'},
      'part5': {start:80,end:90,name:'Synthesis & Wrap-Up'}
    };

    let state = { theme: (localStorage.getItem('pref_theme') || 'light'), progressSection: 'part1', completed: {} };

    // ---------- Utilities ----------
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    function saveState(){ localStorage.setItem(APP_KEY, JSON.stringify(state)); }
    function loadState(){ try{ const s = JSON.parse(localStorage.getItem(APP_KEY)); if(s) state = {...state,...s}; }catch(e){} }

    function showToast(msg){ const t = $('#toast'); $('#toastMsg').textContent = msg; t.hidden = false; t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); },3000); }

    // ---------- Theme ----------
    function applyTheme
    function applyDyslexia(){document.documentElement.classList.toggle('dyslexia-mode',dyslexia);$('#dyslexiaToggle').setAttribute('aria-pressed',String(dyslexia));}
    (){
      const isDark = state.theme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      $('#themeToggle').setAttribute('aria-pressed', String(isDark));
      $('#themeIcon').innerHTML = isDark ? '<path d="M12 3.1A9 9 0 1 0 21 12 7 7 0 0 1 12 3.1z" fill="currentColor"/>' : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="currentColor"/>';
    }

    // ---------- Copy buttons ----------
    function copyText(text){ navigator.clipboard?.writeText(text).then(()=>showToast('Copied to clipboard'), ()=>showToast('Copy failed')); }

    // ---------- Progress ----------
    function updateProgress(sectionId='part1'){
      const s = sectionTimes[sectionId]; if(!s) return;
      const percent = (s.end / 90) * 100; $('#progressBar').style.width = percent + '%';
      $('#progressTime').textContent = `${s.start}:00-${s.end}:00 / 90 min: ${s.name}`;
      state.progressSection = sectionId; saveState();
    }

    // ---------- IntersectionObserver for sections ----------
    function setupObserver(){
      const sections = Object.keys(sectionTimes).map(id => document.getElementById(id)).filter(Boolean);
      const observer = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting && e.intersectionRatio>=0.5){
            updateProgress(e.target.id);
            $$('.nav-link').forEach(l => l.classList.remove('font-bold', 'text-orange-600'));
            const link = document.querySelector(`a[href*="#${e.target.id}"]`);
            if(link) link.classList.add('font-bold','text-orange-600');
          }
        });
      }, {threshold:[0.5], rootMargin:'-40% 0px -40% 0px'});

      sections.forEach(sec=>observer.observe(sec));
    }

    // ---------- Event wiring ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadState(); applyTheme(); applyDyslexia(); setupObserver(); lucide.createIcons();

      // theme toggle
      $('#dyslexiaToggle').addEventListener('click',()=>{ dyslexia=!dyslexia; localStorage.setItem('pref_dyslexia', dyslexia?'on':'off'); applyDyslexia(); });
      $('#themeToggle').addEventListener('click', ()=>{ state.theme = state.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem('pref_theme', state.theme); applyTheme(); saveState(); });

      // TOC toggles
      $('#tocBtn').addEventListener('click', ()=>{ const p = $('#tocPanel'); const open = p.classList.toggle('translate-x-0'); p.setAttribute('aria-hidden', String(!open)); $('#tocBtn').setAttribute('aria-expanded', String(open)); });
      $('#tocClose').addEventListener('click', ()=>{ const p = $('#tocPanel'); p.classList.add('translate-x-full'); p.setAttribute('aria-hidden','true'); $('#tocBtn').setAttribute('aria-expanded', 'false'); });

      // copy buttons
      $('#copyBroken').addEventListener('click', ()=> copyText($('#brokenCode').value));
      $('#copyBasicCode').addEventListener('click', ()=> {
        const pre = document.querySelector('#part3 pre'); copyText(pre.textContent);
      });
      $('#copyToggle').addEventListener('click', ()=> copyText($('#toggleTemplate').value));
      $$('.nav-link').forEach(a=> a.addEventListener('click', ()=>{ /* close toc on mobile */ $('#tocPanel').classList.add('translate-x-full'); $('#tocPanel').setAttribute('aria-hidden','true'); }));

      // broken code check
      $('#checkFix').addEventListener('click', ()=>{
        const code = $('#brokenCode').value;
        const fb = $('#fixFeedback'); fb.classList.remove('hidden');
        if(code.includes('digitalWrite(13, LOW);')){
          fb.className = 'mt-3 p-3 rounded bg-green-50 text-green-800'; fb.innerHTML = '<strong>Excellent!</strong> The second call should be <code>digitalWrite(13, LOW);</code> so the LED turns off.';
        } else {
          fb.className = 'mt-3 p-3 rounded bg-red-50 text-red-800'; fb.innerHTML = '<strong>Not quite.</strong> Change the second <code>digitalWrite(13, HIGH);</code> to <code>LOW</code>.';
        }
      });

      // simulate toggle logic and visual
      const visualLed = $('#visualLed'); const visualBtn = $('#visualBtn'); let simulatedLedOn = false;
      $('#simulateToggle').addEventListener('click', ()=>{
        const txt = $('#toggleTemplate').value;
        if(txt.includes('ledIsOn = !ledIsOn') || txt.includes('ledIsOn=!ledIsOn')){ showToast('Toggle logic detected ‚Äî good!'); } else showToast('Add state flip: ledIsOn = !ledIsOn;');
      });

      visualBtn.addEventListener('mousedown', ()=>{ simulatedLedOn = !simulatedLedOn; visualLed.classList.toggle('on', simulatedLedOn); });
      visualBtn.addEventListener('click', ()=> visualBtn.classList.add('animate-ping')); setTimeout(()=>visualBtn.classList.remove('animate-ping'),500);

      // Save reflection + download
      $('#saveReflection').addEventListener('click', ()=>{
        const obj = { reflection: $('#showTellReflection').value, confidence: $('#confidence').value, timestamp: new Date().toISOString() };
        localStorage.setItem('week2_answers', JSON.stringify(obj)); showToast('Answers saved locally');
      });

      $('#downloadNotes').addEventListener('click', ()=>{
        const notes = `Reflection:\n${$('#showTellReflection').value}\n\nConfidence:\n${$('#confidence').value}`;
        const blob = new Blob([notes], {type:'text/plain'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'week2_notes.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // copy toggle on keyboard (CMD/CTRL+S suggestion)
      document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); $('#saveReflection').click(); showToast('Saved (Ctrl+S)'); }});

      // last updated (use Git commit date if available; fallback to current date)
      const metaUpdated = document.querySelector('meta[name="last-modified"]');
      $('#lastUpdated').textContent = new Date().toLocaleString();

      // mark previous progress
      updateProgress(state.progressSection || 'part1');
    });

    // small accessibility: prevent focus traps when toc opens
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ $('#tocPanel').classList.add('translate-x-full'); $('#tocPanel').setAttribute('aria-hidden','true'); $('#tocBtn').setAttribute('aria-expanded','false'); } });
  </script>
</body>
</html>
