<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week 6: Ambient Color Lamp | Interactive Class</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg-light: #f8fafc;
            --text-light: #1e293b;
            --card-light: #ffffff;
            --bg-dark: #0f172a;
            --text-dark: #e2e8f0;
            --card-dark: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        /* Reset & Base */
        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background-color: var(--bg-light);
            color: var(--text-light);
            padding-bottom: 80px; /* Space for bottom nav if needed */
        }
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        /* Layout & Containers */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        section {
            margin-bottom: 40px;
            padding: 30px;
            background: var(--card-light);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s forwards;
            display: none; /* Hidden by default, toggled via JS */
        }
        section.active { display: block; }
        body.dark-mode section { background: var(--card-dark); }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* Typography */
        h1, h2, h3 { color: var(--primary); margin-top: 0; }
        .subtitle { font-size: 1.1em; opacity: 0.8; margin-bottom: 20px; }
        code { background: rgba(99, 102, 241, 0.1); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: var(--primary-dark); }
        body.dark-mode code { color: #818cf8; background: rgba(99, 102, 241, 0.2); }

        /* Header & Nav */
        header {
            background: var(--card-light);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode header { background: var(--card-dark); }
        .nav-controls { display: flex; gap: 15px; align-items: center; }
        .progress-bar-container {
            flex-grow: 1;
            margin: 0 20px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            max-width: 300px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s ease;
        }
        button.theme-toggle, button.nav-btn {
            background: none;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        button.theme-toggle:hover, button.nav-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Opening Activity - Color Mixer */
        .color-stage {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .light-bulb {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: background 0.3s, box-shadow 0.3s;
            border: 2px solid #555;
        }
        .mix-result {
            width: 100px;
            height: 100px;
            border: 4px dashed var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .slider-group { margin: 15px 0; }
        input[type="range"] { width: 100%; cursor: pointer; }

        /* Objectives Cards */
        .obj-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .obj-card {
            background: rgba(99, 102, 241, 0.05);
            padding: 20px;
            border-radius: var(--radius);
            border-left: 5px solid var(--primary);
        }

        /* Concept Accordion */
        .accordion { margin-top: 20px; }
        .accordion-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .accordion-header {
            padding: 15px;
            background: rgba(0,0,0,0.03);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .accordion-body {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .accordion-item.open .accordion-body {
            padding: 15px;
            max-height: 500px; /* Arbitrary large number */
        }
        
        /* Interactive Troubleshooting (Game) */
        .scenario-box {
            background: var(--bg-light);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }
        body.dark-mode .scenario-box { background: #0f172a; border-color: #334155; }
        .options-grid {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        .option-btn {
            padding: 12px;
            background: var(--card-light);
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
        }
        body.dark-mode .option-btn { background: var(--card-dark); border-color: #475569; }
        .option-btn:hover { border-color: var(--primary); }
        .option-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .option-btn.incorrect { background: var(--danger); color: white; border-color: var(--danger); }

        /* CCQ Styling */
        .ccq-container {
            border: 2px solid var(--warning);
            background: rgba(245, 158, 11, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: var(--radius);
            position: relative;
        }
        .ccq-badge {
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--warning);
            color: #000;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Vocabulary */
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .vocab-card {
            background: var(--bg-light);
            padding: 15px;
            border-radius: var(--radius);
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .vocab-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        body.dark-mode .vocab-card { background: var(--bg-dark); border-color: #334155; }
        .speaker-icon { float: right; opacity: 0.6; }
        .speaker-icon:hover { opacity: 1; color: var(--primary); }

        /* Wrap Up & Badge */
        .wrap-up-form textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            background: transparent;
            color: inherit;
        }
        .badge-display {
            text-align: center;
            padding: 30px;
            border: 4px double var(--primary);
            border-radius: 20px;
            margin-top: 20px;
            display: none;
            background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(236,72,153,0.1));
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-footer {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }

        /* Responsive */
        @media (max-width: 600px) {
            header { flex-direction: column; gap: 10px; }
            .progress-bar-container { width: 100%; margin: 10px 0; }
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; font-size:1.2em;">üí° Ambient Lamp Class</div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="nav-controls">
        <span id="timeEst">90 min</span>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Dark Mode">‚óë</button>
    </div>
</header>

<div class="container">

    <!-- 1. OPENING ACTIVITY -->
    <section id="sec-opening" class="active">
        <h1>Welcome, Makers! üëã</h1>
        <p class="subtitle">Opening Activity: The Mystery of Light Mixing</p>
        
        <div class="obj-card">
            <h3>üé® Challenge: Predict the Light</h3>
            <p>We know that in Art class, mixing all paint colors makes a muddy brown/black. But what happens when we mix <strong>Light</strong>?</p>
            <p>Use the sliders below to predict what color appears in the center when Red, Green, and Blue lights are at full power.</p>
        </div>

        <div class="color-stage">
            <div style="text-align:center">
                <div class="light-bulb" id="bulbR" style="background:#000;"></div>
                <label>Red</label>
                <input type="range" min="0" max="255" value="0" oninput="updateColorMixer()" id="rangeR">
            </div>
            <div style="text-align:center">
                <div class="light-bulb" id="bulbG" style="background:#000;"></div>
                <label>Green</label>
                <input type="range" min="0" max="255" value="0" oninput="updateColorMixer()" id="rangeG">
            </div>
            <div style="text-align:center">
                <div class="light-bulb" id="bulbB" style="background:#000;"></div>
                <label>Blue</label>
                <input type="range" min="0" max="255" value="0" oninput="updateColorMixer()" id="rangeB">
            </div>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
            <h3>Result: <span id="colorResultName">Black (Off)</span></h3>
            <div class="mix-result" id="mixResult" style="margin:0 auto; background:rgb(0,0,0);">?</div>
        </div>

        <div id="openingReflection" style="display:none; margin-top:20px;">
            <p><strong>Reflection:</strong> Were you surprised that Red + Green = Yellow? Or that all three make White? This is <em>Additive Color Theory</em>, the foundation of our project today!</p>
            <button class="btn-primary" onclick="saveOpeningAndNext()">Save & Start Lesson</button>
        </div>
    </section>

    <!-- 2. LEARNING OBJECTIVES -->
    <section id="sec-objectives">
        <h1>Learning Objectives üéØ</h1>
        <p>By the end of this 90-minute session, you will be able to:</p>
        
        <div class="obj-grid">
            <div class="obj-card">
                <h3>üß† Cognitive</h3>
                <ul>
                    <li><strong>Construct</strong> a functional RGB LED circuit on a breadboard using correct resistors.</li>
                    <li><strong>Explain</strong> the difference between <code>digitalWrite</code> (ON/OFF) and <code>analogWrite</code> (PWM) for color mixing.</li>
                    <li><strong>Debug</strong> common wiring errors like swapped polarity or misplaced resistors.</li>
                </ul>
            </div>
            <div class="obj-card">
                <h3>‚ù§Ô∏è Social-Emotional</h3>
                <ul>
                    <li><strong>Resilience:</strong> Use the troubleshooting flowchart to solve problems before asking for help.</li>
                    <li><strong>Collaboration:</strong> Effectively rotate roles (Coder vs. Builder) during the group activity.</li>
                </ul>
            </div>
        </div>

        <div class="nav-footer">
            <button class="nav-btn" onclick="prevSection()">‚Üê Back</button>
            <button class="nav-btn" onclick="nextSection()">Concept Exploration ‚Üí</button>
        </div>
    </section>

    <!-- 3. CONCEPT EXPLORATION -->
    <section id="sec-concepts">
        <h1>Concept Exploration üìö</h1>
        <p>Click the cards to reveal the core concepts for this week's build.</p>

        <div class="accordion">
            <!-- Concept 1 -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    1. The RGB LED: 4 Legs? Why?
                    <span>‚ñº</span>
                </div>
                <div class="accordion-body">
                    <p>An RGB LED is actually <strong>3 small LEDs</strong> (Red, Green, Blue) packaged inside one plastic shell.</p>
                    <div style="display:flex; justify-content:space-around; align-items:center; flex-wrap:wrap;">
                        <div style="background:#eee; padding:10px; border-radius:8px; color:black;">
                            <strong>Wiring Key:</strong><br>
                            Leg 1: Red<br>
                            Leg 2 (Longest): <strong>Common Cathode (-)</strong><br>
                            Leg 3: Blue<br>
                            Leg 4: Green
                        </div>
                        <p><em>Analogy:</em> It's like a 3-flavor soft serve machine. All three nozzles share the same drain (Ground/Cathode), but have separate handles (Pins) to control the flow.</p>
                    </div>
                </div>
            </div>

            <!-- Concept 2 -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    2. PWM: How we "dim" LEDs
                    <span>‚ñº</span>
                </div>
                <div class="accordion-body">
                    <p>Arduino pins are digital (0V or 5V). They can't output 2.5V. So how do we make an LED half-bright?</p>
                    <p><strong>Pulse Width Modulation (PWM)</strong> turns the pin on and off super fast. Your eyes are too slow to see the flickering, so it just looks dimmer.</p>
                    <ul style="background:rgba(0,0,0,0.05); padding:15px; border-radius:8px;">
                        <li><code>analogWrite(pin, 0)</code> = 0% Duty Cycle (OFF)</li>
                        <li><code>analogWrite(pin, 127)</code> = 50% Duty Cycle (Medium)</li>
                        <li><code>analogWrite(pin, 255)</code> = 100% Duty Cycle (Full Brightness)</li>
                    </ul>
                </div>
            </div>

            <!-- Concept 3 -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    3. Resistors: The Gatekeepers
                    <span>‚ñº</span>
                </div>
                <div class="accordion-body">
                    <p><strong>Crucial Rule:</strong> Each color channel (R, G, B) needs its own <strong>220Œ© resistor</strong>.</p>
                    <p><strong>Why?</strong> Red, Green, and Blue LEDs require different voltages. If you share one resistor on the ground leg, the Red LED (which is "hungrier") will hog all the current, and the Blue/Green won't light up!</p>
                </div>
            </div>
        </div>

        <!-- Quick Check -->
        <div style="margin-top:30px; border-top:1px solid #ccc; padding-top:20px;">
            <h3>‚ö° Quick Check</h3>
            <p>If I want to make the color <strong>Purple</strong>, which pins should I send PWM signals to?</p>
            <button class="option-btn" onclick="checkQuick(this, false)">Red + Green</button>
            <button class="option-btn" onclick="checkQuick(this, true)">Red + Blue</button>
            <button class="option-btn" onclick="checkQuick(this, false)">Blue + Green</button>
            <p id="quickFeedback" style="font-weight:bold; margin-top:10px;"></p>
        </div>

        <div class="nav-footer">
            <button class="nav-btn" onclick="prevSection()">‚Üê Back</button>
            <button class="nav-btn" onclick="nextSection()">Applied Examples ‚Üí</button>
        </div>
    </section>

    <!-- 4. APPLIED EXAMPLES -->
    <section id="sec-examples">
        <h1>Applied Examples: The Code üíª</h1>
        <p>Let's look at how we translate "Mixing Colors" into Arduino C++.</p>

        <div class="scenario-box">
            <h3>Example 1: The `setColor` Function</h3>
            <p>Instead of writing 3 `analogWrite` lines every time, we create a helper function.</p>
            <pre><code>
void setColor(int r, int g, int b) {
  analogWrite(redPin, r);   // value 0-255
  analogWrite(greenPin, g); // value 0-255
  analogWrite(bluePin, b);  // value 0-255
}

// In loop():
setColor(255, 0, 0); // Makes Red
setColor(255, 0, 255); // Makes Magenta
            </code></pre>
        </div>

        <div class="scenario-box">
            <h3>Example 2: Breathing Effect (Loops)</h3>
            <p>To make the lamp "breathe", we use a <code>for</code> loop to gradually increase brightness.</p>
            <button class="btn-primary" onclick="document.getElementById('sol1').style.display='block'">Show Code Logic</button>
            <div id="sol1" style="display:none; margin-top:15px; border-left:3px solid var(--success); padding-left:10px;">
                <pre><code>
// Fade IN
for(int i = 0; i <= 255; i++) {
  setColor(i, 0, 0); // Slowly brighten red
  delay(10); // Wait a tiny bit
}

// Fade OUT
for(int i = 255; i >= 0; i--) {
  setColor(i, 0, 0); // Slowly dim red
  delay(10);
}
                </code></pre>
                <p><small><em>Differentiation Note: Advanced students can try using Sine waves for smoother breathing!</em></small></p>
            </div>
        </div>

        <div class="nav-footer">
            <button class="nav-btn" onclick="prevSection()">‚Üê Back</button>
            <button class="nav-btn" onclick="nextSection()">Practice & CCQs ‚Üí</button>
        </div>
    </section>

    <!-- 5. PRACTICE & CCQs (Interactive Activity) -->
    <section id="sec-practice">
        <h1>Troubleshooting Simulator üîß</h1>
        <p>In the real build, things often go wrong. Test your skills by diagnosing these virtual circuit disasters!</p>
        <p class="subtitle">Gain points to unlock the Certificate.</p>

        <div id="quiz-container">
            <!-- Questions injected via JS -->
        </div>

        <div id="quiz-feedback" style="margin-top:20px;"></div>

        <div class="nav-footer">
            <button class="nav-btn" onclick="prevSection()">‚Üê Back</button>
            <button class="nav-btn" id="btn-to-synth" disabled onclick="nextSection()">Synthesis ‚Üí</button>
        </div>
    </section>

    <!-- 6. SYNTHESIS & VOCABULARY -->
    <section id="sec-synthesis">
        <h1>Vocabulary & Synthesis üó£Ô∏è</h1>
        
        <div style="margin-bottom: 30px;">
            <h3>Interactive Vocabulary</h3>
            <input type="text" id="vocabSearch" placeholder="Search terms (e.g., Anode)..." onkeyup="filterVocab()" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc;">
            
            <div class="vocab-grid" id="vocabGrid">
                <!-- Vocab cards injected via JS -->
            </div>
        </div>

        <div class="obj-card" style="background: var(--bg-light); border-color: var(--secondary);">
            <h3>Concept Map Check</h3>
            <p>Drag the component to its function:</p>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <div style="width:45%">
                    <strong>Components:</strong>
                    <div class="option-btn" draggable="true">Resistor</div>
                    <div class="option-btn" draggable="true" style="margin-top:5px">Cathode</div>
                </div>
                <div style="width:45%">
                    <strong>Functions:</strong>
                    <div style="border:1px dashed #ccc; padding:10px; margin-bottom:5px;">Limits Current</div>
                    <div style="border:1px dashed #ccc; padding:10px;">Connects to Ground</div>
                </div>
            </div>
            <p style="font-size:0.8em; color:gray;">(Self-check: Resistors limit current, Cathode goes to ground!)</p>
        </div>

        <div class="nav-footer">
            <button class="nav-btn" onclick="prevSection()">‚Üê Back</button>
            <button class="nav-btn" onclick="nextSection()">Wrap Up ‚Üí</button>
        </div>
    </section>

    <!-- 7. WRAP UP & CLOSURE -->
    <section id="sec-wrapup">
        <h1>Wrap Up & Celebration üéâ</h1>
        
        <!-- A. Knowledge Consolidation -->
        <div class="wrap-up-form">
            <h3>3-2-1 Reflection</h3>
            <p>Please complete this before closing the session.</p>
            
            <label><strong>3</strong> things you learned today:</label>
            <textarea id="ref3" placeholder="1. RGB mixing... 2. Resistors..."></textarea>
            
            <label><strong>2</strong> interesting things/challenges:</label>
            <textarea id="ref2" placeholder="I liked the breathing effect..."></textarea>
            
            <label><strong>1</strong> question you still have:</label>
            <textarea id="ref1" placeholder="How do I add a music sensor?"></textarea>

            <!-- B. Objective Confirmation -->
            <div style="margin:20px 0; background:rgba(0,0,0,0.03); padding:15px; border-radius:8px;">
                <h4>Self-Check:</h4>
                <label style="display:block; margin:5px 0;">
                    <input type="checkbox" id="check1"> I can wire an RGB LED correctly.
                </label>
                <label style="display:block; margin:5px 0;">
                    <input type="checkbox" id="check2"> I understand why we use PWM (0-255).
                </label>
                <label style="display:block; margin:5px 0;">
                    <input type="checkbox" id="check3"> I helped my teammate troubleshoot.
                </label>
            </div>

            <button class="btn-primary" onclick="generateBadge()">Finish Class</button>
        </div>

        <!-- E. Celebration Element -->
        <div id="badgeDisplay" class="badge-display">
            <h2>üèÜ Arduino Ambient Master</h2>
            <div style="font-size:3em; margin:10px;">‚≠ê‚≠ê</div>
            <p>Week 6 Module Completed!</p>
            <p id="badgeName" style="font-weight:bold;"></p>
            <p style="font-size:0.9em; margin-top:15px;">Next Week: Adding Buttons & Mode Switching!</p>
            <button class="nav-btn" onclick="window.print()">Print/Save PDF</button>
        </div>
        
        <div class="nav-footer">
            <button class="nav-btn" onclick="prevSection()">‚Üê Back</button>
        </div>
    </section>

</div>

<script>
    // --- STATE MANAGEMENT ---
    let currentSectionIndex = 0;
    const sections = ['sec-opening', 'sec-objectives', 'sec-concepts', 'sec-examples', 'sec-practice', 'sec-synthesis', 'sec-wrapup'];
    let score = 0;
    let quizCompleted = false;

    // --- INITIALIZATION ---
    window.onload = function() {
        loadProgress();
        renderVocab();
        renderQuiz();
    };

    function updateProgress() {
        const progress = ((currentSectionIndex + 1) / sections.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        localStorage.setItem('ambientLamp_progress', currentSectionIndex);
    }

    function showSection(index) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(sections[index]).classList.add('active');
        currentSectionIndex = index;
        updateProgress();
        window.scrollTo(0,0);
    }

    function nextSection() {
        if (currentSectionIndex < sections.length - 1) {
            showSection(currentSectionIndex + 1);
        }
    }

    function prevSection() {
        if (currentSectionIndex > 0) {
            showSection(currentSectionIndex - 1);
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('ambientLamp_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    function loadProgress() {
        const savedTheme = localStorage.getItem('ambientLamp_theme');
        if (savedTheme === 'dark') document.body.classList.add('dark-mode');
        // We start at opening every time to ensure hook engagement, but could restore index if desired
    }

    // --- OPENING ACTIVITY LOGIC ---
    function updateColorMixer() {
        const r = document.getElementById('rangeR').value;
        const g = document.getElementById('rangeG').value;
        const b = document.getElementById('rangeB').value;

        // Visual feedback on bulbs
        document.getElementById('bulbR').style.background = `rgb(${r}, 0, 0)`;
        document.getElementById('bulbR').style.boxShadow = `0 0 ${r/10}px rgb(${r}, 0, 0)`;
        
        document.getElementById('bulbG').style.background = `rgb(0, ${g}, 0)`;
        document.getElementById('bulbG').style.boxShadow = `0 0 ${g/10}px rgb(0, ${g}, 0)`;
        
        document.getElementById('bulbB').style.background = `rgb(0, 0, ${b})`;
        document.getElementById('bulbB').style.boxShadow = `0 0 ${b/10}px rgb(0, 0, ${b})`;

        // Mix Result
        const resBox = document.getElementById('mixResult');
        resBox.style.background = `rgb(${r}, ${g}, ${b})`;
        resBox.innerHTML = "";

        // Determine name
        let name = "Custom";
        if(r>200 && g>200 && b>200) name="White";
        else if(r<50 && g<50 && b<50) name="Black (Off)";
        else if(r>200 && g<50 && b<50) name="Red";
        else if(r<50 && g>200 && b<50) name="Green";
        else if(r<50 && g<50 && b>200) name="Blue";
        else if(r>200 && g>200 && b<50) name="Yellow"; // Additive!
        else if(r>200 && g<50 && b>200) name="Magenta";
        else if(r<50 && g>200 && b>200) name="Cyan";
        
        document.getElementById('colorResultName').innerText = name;

        // Show Next button if interacted
        if (r > 0 || g > 0 || b > 0) {
            document.getElementById('openingReflection').style.display = 'block';
        }
    }

    function saveOpeningAndNext() {
        localStorage.setItem('ambientLamp_opening_done', 'true');
        nextSection();
    }

    // --- CONCEPTS ---
    function toggleAccordion(header) {
        const item = header.parentElement;
        item.classList.toggle('open');
        const arrow = header.querySelector('span');
        arrow.innerText = item.classList.contains('open') ? '‚ñ≤' : '‚ñº';
    }

    function checkQuick(btn, isCorrect) {
        const fb = document.getElementById('quickFeedback');
        if (isCorrect) {
            fb.style.color = 'var(--success)';
            fb.innerText = "Correct! Red + Blue = Magenta/Purple.";
            btn.classList.add('correct');
        } else {
            fb.style.color = 'var(--danger)';
            fb.innerText = "Not quite. Remember the color wheel!";
            btn.classList.add('incorrect');
        }
    }

    // --- PRACTICE & CCQ ENGINE ---
    const quizData = [
        {
            type: 'scenario',
            q: "Scenario 1: You plugged in your LED. The code says 'Red', but the LED lights up Green. What happened?",
            options: ["The LED is broken.", "You swapped the Red and Green wires on Pins 9 & 10.", "The resistor is too small."],
            correct: 1,
            expl: "Crossed wires are the #1 cause of wrong colors. Always trace your wires from Pin to Leg!"
        },
        {
            type: 'ccq',
            title: 'Concept Check: Polarity',
            q: "Negative Check: Would the LED work if we connected the Common Cathode to 5V instead of GND?",
            options: ["Yes, it doesn't matter.", "No, Common Cathode MUST go to Ground."],
            correct: 1,
            expl: "Correct. Cathode means negative. It needs a path to Ground (0V) to complete the circuit."
        },
        {
            type: 'scenario',
            q: "Scenario 2: The Red color works, but Blue and Green are super dim. You used 10kŒ© resistors instead of 220Œ©.",
            options: ["True, higher resistance = dimmer light.", "False, resistance doesn't affect brightness."],
            correct: 0,
            expl: "Right! 10kŒ© resists the flow of electrons too much. 220Œ© is the sweet spot for these LEDs."
        },
        {
            type: 'ccq',
            title: 'Concept Check: Application',
            q: "If we wanted the lamp to be twice as bright, could we just remove the resistors?",
            options: ["Yes, maximum power!", "No, the LED would burn out."],
            correct: 1,
            expl: "Never remove resistors! Without them, too much current flows and the LED will 'pop' (burn out) instantly."
        },
        {
            type: 'scenario',
            q: "Scenario 3: Code Upload Error. The Arduino software says 'Port not found'.",
            options: ["Rewrite the code.", "Check the USB cable and select Port in Tools menu.", "Change the LED."],
            correct: 1,
            expl: "This is a connection issue, not a code issue. Check your USB!"
        }
    ];

    let currentQuizIndex = 0;

    function renderQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        
        if (currentQuizIndex >= quizData.length) {
            container.innerHTML = '<h3 style="color:var(--success)">All Practice Complete!</h3><p>You are ready for the final synthesis.</p>';
            document.getElementById('btn-to-synth').disabled = false;
            return;
        }

        const item = quizData[currentQuizIndex];
        const div = document.createElement('div');
        
        if (item.type === 'ccq') {
            div.className = 'ccq-container';
            div.innerHTML = `<span class="ccq-badge">${item.title}</span>`;
        } else {
            div.className = 'scenario-box';
        }

        div.innerHTML += `<h3>${item.q}</h3><div class="options-grid" id="opts-${currentQuizIndex}"></div>`;
        container.appendChild(div);

        const optsContainer = document.getElementById(`opts-${currentQuizIndex}`);
        item.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => handleQuizAnswer(idx, item.correct, item.expl, btn);
            optsContainer.appendChild(btn);
        });
    }

    function handleQuizAnswer(selected, correct, explanation, btn) {
        const feedback = document.getElementById('quiz-feedback');
        if (selected === correct) {
            btn.classList.add('correct');
            feedback.innerHTML = `<span style="color:var(--success)">‚úî ${explanation}</span>`;
            setTimeout(() => {
                currentQuizIndex++;
                feedback.innerHTML = '';
                renderQuiz();
            }, 2500);
        } else {
            btn.classList.add('incorrect');
            feedback.innerHTML = `<span style="color:var(--danger)">‚úò Try again. Hint: Read the explanation carefully.</span>`;
        }
    }

    // --- VOCABULARY ---
    const vocabList = [
        { term: "RGB", def: "Red Green Blue. The additive color model used for light." },
        { term: "Cathode", def: "The negative (-) terminal of an LED. Connects to Ground." },
        { term: "Anode", def: "The positive (+) terminal. Connects to power/pins." },
        { term: "PWM", def: "Pulse Width Modulation. Rapidly switching on/off to simulate analog voltage." },
        { term: "Duty Cycle", def: "The percentage of time a PWM signal is 'ON'. 100% = Full Brightness." },
        { term: "Ohm (Œ©)", def: "Unit of electrical resistance. We use 220Œ© for our LEDs." },
        { term: "Common Cathode", def: "A type of RGB LED where all 3 colors share one negative leg." }
    ];

    function renderVocab() {
        const grid = document.getElementById('vocabGrid');
        grid.innerHTML = '';
        vocabList.forEach(v => {
            const card = document.createElement('div');
            card.className = 'vocab-card';
            card.innerHTML = `
                <span class="speaker-icon" onclick="speak('${v.term}')">üîä</span>
                <strong>${v.term}</strong>
                <p style="font-size:0.9em; margin-top:5px;">${v.def}</p>
            `;
            grid.appendChild(card);
        });
    }

    function filterVocab() {
        const term = document.getElementById('vocabSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.vocab-card');
        cards.forEach(card => {
            const text = card.innerText.toLowerCase();
            card.style.display = text.includes(term) ? 'block' : 'none';
        });
    }

    function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(utterance);
    }

    // --- WRAP UP ---
    function generateBadge() {
        const r3 = document.getElementById('ref3').value;
        const r2 = document.getElementById('ref2').value;
        const r1 = document.getElementById('ref1').value;
        const c1 = document.getElementById('check1').checked;
        const c2 = document.getElementById('check2').checked;

        if (!r3 || !r2 || !r1 || !c1 || !c2) {
            alert("Please complete the reflection and checklist first!");
            return;
        }

        // Save data
        localStorage.setItem('ambientLamp_reflection', JSON.stringify({r3, r2, r1}));
        
        // Show Badge
        document.querySelector('.wrap-up-form').style.display = 'none';
        document.getElementById('badgeDisplay').style.display = 'block';
        
        // Add name if available or generic
        document.getElementById('badgeName').innerText = "Awarded for Excellence in RGB Circuitry";
        
        // Confetti effect (simple visual cue)
        document.body.style.overflow = 'hidden';
        setTimeout(() => document.body.style.overflow = 'auto', 3000);
    }
</script>

</body>
</html>